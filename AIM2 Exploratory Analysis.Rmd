---
title: "AIM2 Exploration"
author: "Adam Jauregui"
date: "March 12, 2019"
output: word_document
---

```{r setup, include=FALSE}
library(readr)
library(lubridate)
library(plyr)
library(dplyr)
library(tidyr)
#library(naniar)
library(summarytools)
library(arsenal)
library(stringr)
library(flextable)
library(officer)
library(ggplot2)
library(arsenal)
library(scales)
library(Hmisc)
MergedAIM2_QX <- read_csv("C:/Users/Adam/Documents/BSRI/TIP Stuff/MergedAIM2_QX/MergedAIM2_QX_csv.csv")
View(MergedAIM2_QX)

#get dimensions and view structure
#dim(MergedAIM2_QX)
#glimpse(MergedAIM2_QX)

#look for typos in the variables of the data frame
#sapply(MergedAIM2_QX[1:50],unique)
#Collection Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>%
  separate(`Collection Date`,
           c("Collection_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Collection_Date<-as.Date(
  MergedAIM2_QX$Collection_Date,format="%d-%b-%y")
#Registration Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate(`Registration Date`,
           c("Registration_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Registration_Date<-as.Date(
  MergedAIM2_QX$Registration_Date,format="%d-%b-%y")
#TodayDate: change to date format d/m/y
MergedAIM2_QX$TodayDate<-as.Date(MergedAIM2_QX$TodayDate,
                                 format="%d/%m/%Y")
#sapply(MergedAIM2_QX[51:150],unique)
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("BLOODCOLLECTIONDATE",
           c("BLOODCOLLECTIONDATE","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$BLOODCOLLECTIONDATE<-as.Date(
  MergedAIM2_QX$BLOODCOLLECTIONDATE,format="%Y-%m-%d")
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("CHARTABSTRATIONDATE",
           c("CHARTABSTRATIONDATE","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$CHARTABSTRATIONDATE<-as.Date(
  MergedAIM2_QX$CHARTABSTRATIONDATE,format="%Y-%m-%d")
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("CONSENTDATE",
           c("CONSENTDATE","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$CONSENTDATE<-as.Date(
  MergedAIM2_QX$CONSENTDATE,format="%Y-%m-%d")
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("CREATEDDATE",
           c("CREATEDDATE","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$CREATEDDATE<-as.Date(
  MergedAIM2_QX$CREATEDDATE,format="%Y-%m-%d")
#AAF_TodayDate: change to date format d/m/y
MergedAIM2_QX$AAF_TodayDate<-as.Date(MergedAIM2_QX$AAF_TodayDate,
                                     format="%d/%m/%Y")
#SecondCountry: change value of "sa" (and maybe "SSA") to "SA"
#AAF_PostalCode: all are 4 digits except for two (904 and 745)
#AAF_PostalCode_2ndRes: all begin with the digit "1" except for two (2143 and 7785)
#AAF_Gravidity: values of 62 and 92
#AAF_Parity: values of 91 and 61
#AAF_NumVisitsRefAnteClinic: values of 62, 61, 64, 81, and 98
#sapply(MergedAIM2_QX[151:250],unique)
#AAF_DateHbObained: change to date format d/m/y
MergedAIM2_QX$AAF_DateHbObtained<-as.Date(MergedAIM2_QX$AAF_DateHbObtained,
                                          format="%d/%m/%Y")
#AAF_IronSulphateDate: change to date format d/m/y
MergedAIM2_QX$AAF_IronSulphateDate<-as.Date(MergedAIM2_QX$AAF_IronSulphateDate,
                                            format="%d/%m/%Y")
#AAF_FolicAcidDate: change to date format d/m/y
MergedAIM2_QX$AAF_FolicAcidDate<-as.Date(MergedAIM2_QX$AAF_FolicAcidDate,
                                         format="%d/%m/%Y")
#AAF_VitaminCDate: change to date format d/m/y
MergedAIM2_QX$AAF_VitaminCDate<-as.Date(MergedAIM2_QX$AAF_VitaminCDate,
                                        format="%d/%m/%Y")
#AAF_VitaminADate: change to date format d/m/y
MergedAIM2_QX$AAF_VitaminADate<-as.Date(MergedAIM2_QX$AAF_VitaminADate,
                                        format="%d/%m/%Y")
#AAF_VitaminB12Date: change to date format d/m/y
MergedAIM2_QX$AAF_VitaminB12Date<-as.Date(MergedAIM2_QX$AAF_VitaminB12Date,
                                          format="%d/%m/%Y")
#AAF_ThiamineDate: change to date format d/m/y
MergedAIM2_QX$AAF_ThiamineDate<-as.Date(MergedAIM2_QX$AAF_ThiamineDate,
                                        format="%d/%m/%Y")
#AAF_OtherIronDate: change to date format d/m/y
MergedAIM2_QX$AAF_OtherIronDate<-as.Date(MergedAIM2_QX$AAF_OtherIronDate,
                                         format="%d/%m/%Y")
#AAF_RefForAnemiaDate: change to date format d/m/y
MergedAIM2_QX$AAF_RefForAnemiaDate<-as.Date(MergedAIM2_QX$AAF_RefForAnemiaDate,
                                            format="%d/%m/%Y")
#AAF_1stSpecialistAnteAnemiaVisit: change to date format d/m/y
MergedAIM2_QX$AAF_1stSpecialistAnteAnemiaVisit<-as.Date(
  MergedAIM2_QX$AAF_1stSpecialistAnteAnemiaVisit,format="%d/%m/%Y")
#AAF_ReasonForReferral: fix spelling of "Reason" (some spelled as "Raeson")
#AAF_AACRx_IronSulphate_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_IronSulphate_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_IronSulphate_Date,format="%d/%m/%Y")
#AAF_AACRx_FolicAcid_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_FolicAcid_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_FolicAcid_Date,format="%d/%m/%Y")
#AAF_AACRx_VitC_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_VitC_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_VitC_Date,format="%d/%m/%Y")
#AAF_AACRx_VitA_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_VitA_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_VitA_Date,format="%d/%m/%Y"
)
#AAF_AACRx_VitB12_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_VitA_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_VitA_Date,format="%d/%m/%Y"
)
#AAF_AACRx_Thiamine_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_Thiamine_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_Thiamine_Date,format="%d/%m/%Y"
)
#AAF_AACRx_OthIronSup_Date: change to date format d/m/y
MergedAIM2_QX$AAF_AACRx_OthIronSup_Date<-as.Date(
  MergedAIM2_QX$AAF_AACRx_OthIronSup_Date,format="%d/%m/%Y"
)
#sapply(MergedAIM2_QX[251:350],unique)
#AAF_CurrLMP: change to date format d/m/y
MergedAIM2_QX$AAF_CurrLMP<-as.Date(
  MergedAIM2_QX$AAF_CurrLMP,format="%d/%m/%Y"
)
#AAF_CurrEstDateDelv: change to date format d/m/y
MergedAIM2_QX$AAF_CurrEstDateDelv<-as.Date(
  MergedAIM2_QX$AAF_CurrEstDateDelv,format="%d/%m/%Y"
)
#AAF_CurrBookingDate: change to date format d/m/y
MergedAIM2_QX$AAF_CurrBookingDate<-as.Date(
  MergedAIM2_QX$AAF_CurrBookingDate,format="%d/%m/%Y"
)
#AAF_AACRespRate: values range between 16 and 24, outlier of 820
#BookingHIVStatusDate: change to date format d/m/y
MergedAIM2_QX$BookingHIVStatusDate<-as.Date(
  MergedAIM2_QX$BookingHIVStatusDate,format="%d/%m/%Y"
)
#DeliveryAdmitStatusDate: change to date format d/m/y
MergedAIM2_QX$DeliveryAdmitStatusDate<-as.Date(
  MergedAIM2_QX$DeliveryAdmitStatusDate,format="%d/%m/%Y"
)
#OtherTestDurPregHIVStatusDate: change to date format d/m/y
MergedAIM2_QX$OtherTestDurPregHIVStatusDate<-as.Date(
  MergedAIM2_QX$OtherTestDurPregHIVStatusDate,format="%d/%m/%Y"
)
#OtherTestDurPregHIVStatusDate2: change to date format d/m/y
MergedAIM2_QX$OtherTestDurPregHIVStatusDate2<-as.Date(
  MergedAIM2_QX$OtherTestDurPregHIVStatusDate2,format="%d/%m/%Y"
)
#AAF_LastCD4CountDate: change to date format d/m/y
MergedAIM2_QX$AAF_LastCD4CountDate<-as.Date(
  MergedAIM2_QX$AAF_LastCD4CountDate,format="%d/%m/%Y"
)
#AAF_viralLoadDate: change to date format d/m/y
MergedAIM2_QX$AAF_ViralLoadDate<-as.Date(
  MergedAIM2_QX$AAF_ViralLoadDate,format="%d/%m/%Y"
)
#AAF_ARTStartDate: change to date format d/m/y
MergedAIM2_QX$AAF_ARTStartDate<-as.Date(
  MergedAIM2_QX$AAF_ARTStartDate,format="%d/%m/%Y"
)
#sapply(MergedAIM2_QX[351:450],unique)
#AAF_ARTPMTCTStartDate: change to date format d/m/y
MergedAIM2_QX$AAF_ARTPMTCTStartDate<-as.Date(
  MergedAIM2_QX$AAF_ARTPMTCTStartDate,format="%d/%m/%Y"
)
#AAF_StartDateAZT: change to date format d/m/y
MergedAIM2_QX$AAF_StartDateAZT<-as.Date(
  MergedAIM2_QX$AAF_StartDateAZT,format="%d/%m/%Y"
)
#AAF_EndDateAZT: change to date format d/m/y
MergedAIM2_QX$AAF_EndDateAZT<-as.Date(
  MergedAIM2_QX$AAF_EndDateAZT,format="%d/%m/%Y"
)
#AAF_DateTransfusion: change to date format d/m/y
MergedAIM2_QX$AAF_DateTransfusion<-as.Date(
  MergedAIM2_QX$AAF_DateTransfusion,format="%d/%m/%Y"
)
#Transcription_Date: change to date format d/m/y
MergedAIM2_QX$Transcription_Date<-as.Date(
  MergedAIM2_QX$Transcription_Date,format="%d/%m/%Y"
)
#sapply(MergedAIM2_QX[c(401:545)],unique)
#v01_Visit_Date: change to date format d/m/y
MergedAIM2_QX$v01_Visit_Date<-as.Date(
  MergedAIM2_QX$v01_Visit_Date,format="%d/%m/%Y")
#v01_IVI_Iron_date: change to date format d/m/y
MergedAIM2_QX$v01_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v01_IVI_Iron_date,format="%d/%m/%Y"
)
#v02_Visit_Date: change to date format d/m/y
MergedAIM2_QX$v02_Visit_Date<-as.Date(
  MergedAIM2_QX$v02_Visit_Date,format="%d/%m/%Y"
)
#v02_IVI_Iron_date: change to date format d/m/y
MergedAIM2_QX$v02_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v02_IVI_Iron_date,format="%d/%m/%Y"
)
#v02_Transfusion_date: change to date format d/m/y
MergedAIM2_QX$v02_Transfusion_date<-as.Date(
  MergedAIM2_QX$v02_Transfusion_date,format="%d/%m/%Y"
)
#v03_Visit_Date: change to date format d/m/y
MergedAIM2_QX$v03_Visit_Date<-as.Date(
  MergedAIM2_QX$v03_Visit_Date,format="%d/%m/%Y"
)
#v03_IVI_Iron_date: "" format d/m/y
MergedAIM2_QX$v03_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v03_IVI_Iron_date,format="%d/%m/%Y"
)
#v03_Transfusion_date: "" format d/m/y
MergedAIM2_QX$v03_Transfusion_date<-as.Date(
  MergedAIM2_QX$v03_Transfusion_date,format="%d/%m/%Y"
)
#v04_Visit_Date: "" format d/m/y
MergedAIM2_QX$v04_Visit_Date<-as.Date(
  MergedAIM2_QX$v04_Visit_Date,format="%d/%m/%Y"
)
#sapply(MergedAIM2_QX[451:550],unique)
#v04_IVI_Iron_date: d/m/y
MergedAIM2_QX$v04_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v04_IVI_Iron_date,format="%d/%m/%Y"
)
#v04_Tranfuion_date: d/m/y
MergedAIM2_QX$v04_Transfusion_date<-as.Date(
  MergedAIM2_QX$v04_Transfusion_date,format="%d/%m/%Y"
)
#v05_Visit_Date: d/m/y
MergedAIM2_QX$v05_Visit_Date<-as.Date(
  MergedAIM2_QX$v05_Visit_Date,format="%d/%m/%Y"
)
#v05_IVI_Iron_date: d/m/y
MergedAIM2_QX$v05_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v05_IVI_Iron_date,format="%d/%m/%Y"
)
#v05_Transfusion_date: d/m/y
MergedAIM2_QX$v05_Transfusion_date<-as.Date(
  MergedAIM2_QX$v05_Transfusion_date,format="%d/%m/%Y"
)
#v06_Visit_Date: d/m/y
MergedAIM2_QX$v06_Visit_Date<-as.Date(
  MergedAIM2_QX$v06_Visit_Date,format="%d/%m/%Y"
)
#v06_IVI_Iron_date: d/m/y
MergedAIM2_QX$v06_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v06_IVI_Iron_date,format="%d/%m/%Y"
)
#v06_Transfusion_date: d/m/y
MergedAIM2_QX$v06_Transfusion_date<-as.Date(
  MergedAIM2_QX$v06_Transfusion_date,format="%d/%m/%Y"
)
#v07_Visit_Date: d/m/y
MergedAIM2_QX$v07_Visit_Date<-as.Date(
  MergedAIM2_QX$v07_Visit_Date,format="%d/%m/%Y"
)
#v07_IVI_Iron_date: d/m/y
MergedAIM2_QX$v07_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v07_IVI_Iron_date,format="%d/%m/%Y"
)
#v07_Transfusion_date: d/m/y
MergedAIM2_QX$v07_Transfusion_date<-as.Date(
  MergedAIM2_QX$v07_Transfusion_date,format="%d/%m/%Y"
)
#v08_Visit_Date: d/m/y
MergedAIM2_QX$v08_Visit_Date<-as.Date(
  MergedAIM2_QX$v08_Visit_Date,format="%d/%m/%Y"
)
#v08_IVI_Iron_date: d/m/y
MergedAIM2_QX$v08_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v08_IVI_Iron_date,format="%d/%m/%Y"
)
#v08_Transfusion_date: d/m/y
MergedAIM2_QX$v08_Transfusion_date<-as.Date(
  MergedAIM2_QX$v08_Transfusion_date,format="%d/%m/%Y"
)
#v09_Visit_Date: d/m/y
MergedAIM2_QX$v09_Visit_Date<-as.Date(
  MergedAIM2_QX$v09_Visit_Date,format="%d/%m/%Y"
)
#v09_IVI_Iron_date: d/m/y
MergedAIM2_QX$v09_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v09_IVI_Iron_date,format="%d/%m/%Y"
)
#v09_Transfusion_date: d/m/y
MergedAIM2_QX$v09_Transfusion_date<-as.Date(
  MergedAIM2_QX$v09_Transfusion_date,format="%d/%m/%Y"
)
#v10_Visit_Date: d/m/y
MergedAIM2_QX$v10_Visit_Date<-as.Date(
  MergedAIM2_QX$v10_Visit_Date,format="%d/%m/%Y"
)
#v10_IVI_Iron_date: d/m/y
MergedAIM2_QX$v10_IVI_Iron_date<-as.Date(
  MergedAIM2_QX$v10_IVI_Iron_date,format="%d/%m/%Y"
)
#v10_Transfusion_date: d/m/y
MergedAIM2_QX$v10_Transfusion_date<-as.Date(
  MergedAIM2_QX$v10_Transfusion_date,format="%d/%m/%Y")
#v01_Visit_DateA: d/m/y
#MergedAIM2_QX$v01_Visit_DateA<-as.Date(
# MergedAIM2_QX$v01_Visit_DateA,format="%d/%m/%Y")
#v01_Visit_DateB: remove the UTC from the date values, then change to d/m/y,
#                 also a few of the years have a year of 1930, a posible typo
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v01_Visit_DateB",
           c("v01_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v01_Visit_DateB<-as.Date(
  MergedAIM2_QX$v01_Visit_DateB,format="%Y-%m-%d")
#sapply(MergedAIM2_QX[551:650],unique)
#v01_Date: remove the UTC from the date values, then change to d/m/y
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v01_Date",
           c("v01_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v01_Date<-as.Date(
  MergedAIM2_QX$v01_Date,format="%Y-%m-%d")
#v02_Visit_DateA
#MergedAIM2_QX$v02_Visit_DateA<-as.Date(
# MergedAIM2_QX$v02_Visit_DateA,format="%d/%m/%Y")
#v02_Visit_DateB: remove the UTC from the date values, then change to d/m/y,
#                 then check the years for typos
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v02_Visit_DateB",
           c("v02_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v02_Visit_DateB<-as.Date(
  MergedAIM2_QX$v02_Visit_DateB,format="%Y-%m-%d")
#v02_Date: remove the UTC from the date values, then change to d/m/y
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v02_Date",
           c("v02_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v02_Date<-as.Date(
  MergedAIM2_QX$v02_Date,format="%Y-%m-%d")
#v03_Visit_DateA
#MergedAIM2_QX$v03_Visit_DateA<-as.Date(
# MergedAIM2_QX$v03_Visit_DateA,format="%d/%m/%Y")
#v03_Visit_DateB: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v03_Visit_DateB",
           c("v03_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v03_Visit_DateB<-as.Date(
  MergedAIM2_QX$v03_Visit_DateB,format="%Y-%m-%d")
#v03_Date: "... UTC..."
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v03_Date",
           c("v03_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v03_Date<-as.Date(
  MergedAIM2_QX$v03_Date,format="%Y-%m-%d")
#v04_Visit_DateA
#MergedAIM2_QX$v04_Visit_DateA<-as.Date(
# MergedAIM2_QX$v04_Visit_DateA,format="%d/%m/%Y")
#v04_Visit_DateB: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v04_Visit_DateB",
           c("v04_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v04_Visit_DateB<-as.Date(
  MergedAIM2_QX$v04_Visit_DateB,format="%Y-%m-%d")
#v04_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v04_Date",
           c("v04_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v04_Date<-as.Date(
  MergedAIM2_QX$v04_Date,format="%Y-%m-%d")
#v05_Visit_DateA
#MergedAIM2_QX$v05_Visit_DateA<-as.Date(
# MergedAIM2_QX$v05_Visit_DateA,format="%d/%m/%Y")
#v05_Visit_DateB: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v05_Visit_DateB",
           c("v05_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v05_Visit_DateB<-as.Date(
  MergedAIM2_QX$v05_Visit_DateB,format="%Y-%m-%d")
#v05_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v05_Date",
           c("v05_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v05_Date<-as.Date(
  MergedAIM2_QX$v05_Date,format="%Y-%m-%d")
#v06_Visit_DateA
#MergedAIM2_QX$v06_Visit_DateA<-as.Date(
# MergedAIM2_QX$v06_Visit_DateA,format="%d/%m/%Y")
#v06_Visit_DateB: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v06_Visit_DateB",
           c("v06_Visit_DateB","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v06_Visit_DateB<-as.Date(
  MergedAIM2_QX$v06_Visit_DateB,format="%Y-%m-%d")
#v06_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v06_Date",
           c("v06_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v06_Date<-as.Date(
  MergedAIM2_QX$v06_Date,format="%Y-%m-%d")
#v07_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v07_Date",
           c("v07_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v07_Date<-as.Date(
  MergedAIM2_QX$v07_Date,format="%Y-%m-%d")
#v08_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v08_Date",
           c("v08_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v08_Date<-as.Date(
  MergedAIM2_QX$v08_Date,format="%Y-%m-%d")
#v09_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v09_Date",
           c("v09_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v09_Date<-as.Date(
  MergedAIM2_QX$v09_Date,format="%Y-%m-%d")
#v10_Date: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("v10_Date",
           c("v10_Date","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$v10_Date<-as.Date(
  MergedAIM2_QX$v10_Date,format="%Y-%m-%d")
#AAF_TodayDateN
#MergedAIM2_QX$AAF_TodayDateN<-as.Date(
# MergedAIM2_QX$AAF_TodayDateN,format="%d/%m/%Y")
#FirstFUVisit
#MergedAIM2_QX$FirstFUVisit<-as.Date(
 # MergedAIM2_QX$FirstFUVisit,format="%d/%m/%Y")
#Collection_Date1: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Collection_Date1",
           c("Collection_Date1","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Collection_Date1<-as.Date(
  MergedAIM2_QX$Collection_Date1,format="%Y-%m-%d")
#Registration_Date1: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Registration_Date1",
           c("Registration_Date1","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Registration_Date1<-as.Date(
  MergedAIM2_QX$Registration_Date1,format="%Y-%m-%d")
#Haptoglobin1: change from character to numeric variable
#HIV_Viral_Load_cps_mL1: contains a value of "LDL" while the rest are numbers
#Collection_Date2: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Collection_Date2",
           c("Collection_Date2","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Collection_Date2<-as.Date(
  MergedAIM2_QX$Collection_Date2,format="%Y-%m-%d")
#Registration_Date2: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Registration_Date2",
           c("Registration_Date2","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Registration_Date2<-as.Date(
  MergedAIM2_QX$Registration_Date2,format="%Y-%m-%d")
#Pct_Saturation2: contains a value of "UTC" while the rest are numbers
#sapply(MergedAIM2_QX[651:759],unique)
#Collection_Date3: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Collection_Date3",
           c("Collection_Date3","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Collection_Date3<-as.Date(
  MergedAIM2_QX$Collection_Date3,format="%Y-%m-%d")
#Registration_Date3: UTC
MergedAIM2_QX<-MergedAIM2_QX %>% 
  separate("Registration_Date3",
           c("Registration_Date3","utc"),
           sep=" ",extra="merge")
MergedAIM2_QX$Registration_Date3<-as.Date(
  MergedAIM2_QX$Registration_Date3,format="%Y-%m-%d")
#Pct_Saturation: contains a value of "UTC" while the rest are numbers
#HIV_Viral_Load_cps_mL: contains a value of "LDL" while the rest are numbers
#IRON_DEFIC: recode "yes" value to "Yes"

#get counts of unique ID values
attach(MergedAIM2_QX)
#AIM2 Lab Data
sum(!(is.na(`Patient Number`))) #non-NA counts
length(unique(na.omit(`Patient Number`))) #unique counts
#AIM2 Patient Questionnaire
sum(!(is.na(StudyID))) #non-NA counts
length(unique(na.omit(StudyID))) #unique counts 
sum(!(is.na(CaseID))) #non-NA counts
length(unique(na.omit(CaseID))) #unique counts 
#AIM2 Antenatal Anaemia Form (AAF)
sum(!(is.na(SUBJECTID))) #non-NA counts
length(unique(na.omit(SUBJECTID))) #unique counts 
sum(!(is.na(AAF_StudyID))) #non-NA counts
length(unique(na.omit(AAF_StudyID))) #unique counts 
#AIM2 Prospective Visits
sum(!(is.na(Study_ID))) #non-NA counts
length(unique(na.omit(Study_ID))) #unique counts 
detach(MergedAIM2_QX)

#find duplicate rows, if they exist
#AIM2 Lab Data
aim2.lab<-MergedAIM2_QX[c(1:42)]
dups.lab<-duplicated(aim2.lab)
table(dups.lab)
#AIM2 Patient Questionnaire
aim2.pq<-MergedAIM2_QX[c(43:56,58:93)]
dups.pq<-duplicated(aim2.pq)
table(dups.pq)
#Antenatal Anaemia Form
aim2.aaf<-MergedAIM2_QX[c(115:395)]
dups.AAF<-duplicated(aim2.aaf)
table(dups.AAF)
#Prospective Visit
aim2.pv<-MergedAIM2_QX[c(397,400:545)]
dups.pv<-duplicated(aim2.pv)
table(dups.pv)
#scan the dups for a few individuals to make sure no surprises
pq.dupsTF<-aim2.pq
pq.dupsTF$dups.pq<-dups.pq
pq.dupsF<-subset(pq.dupsTF,dups.pq=="FALSE")
pq.dupsT<-subset(pq.dupsTF,dups.pq=="TRUE")
pq.dupsF<-subset(pq.dupsF,select=-c(dups.pq))

#remove duplicate observations
aim2.pq.nodups<-distinct(aim2.pq)
sum(is.na(aim2.pq.nodups$StudyID))
aim2.aaf.nodups<-distinct(aim2.aaf)
sum(is.na(aim2.aaf.nodups$AAF_StudyID))
aim2.pv.nodups<-distinct(aim2.pv)
sum(is.na(aim2.pv.nodups$Study_ID))

#investigate rows with missing ID values
aim2.pq.nodups.naids<-subset(aim2.pq.nodups,is.na(StudyID))
aim2.aaf.nodups.naids<-subset(aim2.aaf.nodups,is.na(AAF_StudyID))
aim2.pv.nodups.naids<-subset(aim2.pv.nodups,is.na(Study_ID))

#remove rows with missing ID values
aim2.pq.ultimate<-subset(aim2.pq.nodups,!(is.na(StudyID)))
aim2.aaf.ultimate<-subset(aim2.aaf.nodups,!(is.na(AAF_StudyID)))
aim2.pv.ultimate<-subset(aim2.pv.nodups,!(is.na(Study_ID)))

#find women who have been transfused
#grep("^v.*Transfusion$",colnames(MergedAIM2_QX))
#attach(MergedAIM2_QX)
#table(AAF_TransfusedCurrPreg,useNA = "ifany") #Were they transfused?
#table(EverHadBloodTx,useNA = "ifany") #Ever had a transfusion?
#detach(MergedAIM2_QX)
#tx.df<-subset(MergedAIM2_QX,
#              AAF_TransfusedCurrPreg=="01 Ye" | 
#                EverHadBloodTx=="01 Ye")
#lapply(tx.df[c(411,425,439,453,467,481,495,509,523,537)],
#       table,useNA="ifany") #tranfusion at visit 1, 2, ..., 10
#summary(freqlist(table(tx.df$AAF_TransfusedCurrPreg,
#                       tx.df$EverHadBloodTx,
#                       useNA = "ifany"),
#                 labelTranslations = c("Tx. Curr. Preg.",
#                                       "Ever Had Tx.")))
  #see if these women have booking dates similar to AIM3
#bloop<-sort(tx.df$AAF_CurrBookingDate)
#blahp<-sort(aim3_chki.tx.conf$ATF_BookingDate)
#bloop
#blahp
  #none do, but do they have similar HIV book dates?
#boop<-sort(tx.df$BookingHIVStatusDate)
#bahp<-sort(aim3_chki.tx.conf$ATF_HIVStatusBookingDate)
#boop
#bahp

#sort the IDs
#aim2.aaf.ultimate<-aim2.aaf.ultimate[
 # order(aim2.aaf.ultimate$AAF_StudyID),]
#aim2.pq.ultimate<-aim2.pq.ultimate[
#  order(aim2.pq.ultimate$StudyID),]
#aim2.pv.ultimate<-aim2.pv.ultimate[
#  order(aim2.pv.ultimate$Study_ID),]

#merge 3 forms into one data set with all matching IDs
#aim2.matched<-inner_join(aim2.aaf.ultimate,
#                         aim2.pq.ultimate,
#                         by=c("AAF_StudyID"="StudyID"))
#aim2.matched<-inner_join(aim2.matched,
 #                        aim2.pv.ultimate,
#                         by=c("AAF_StudyID"="Study_ID"))

#find all the columns that are completely empty
#aim2.na<-MergedAIM2_QX[,colSums(is.na(MergedAIM2_QX))==nrow(MergedAIM2_QX)]
#sapply(aim2.na,function(x) sum(is.na(x)))

#keep the columns that have values
aim2.lab<-aim2.lab[,colSums(is.na(aim2.lab))!=nrow(aim2.lab)]
aim2.pq.ultimate<-aim2.pq.ultimate[,colSums(is.na(aim2.pq.ultimate))!=
                                     nrow(aim2.pq.ultimate)]
aim2.aaf.ultimate<-aim2.aaf.ultimate[,colSums(is.na(aim2.aaf.ultimate))!=
                                       nrow(aim2.aaf.ultimate)]
aim2.pv.ultimate<-aim2.pv.ultimate[,colSums(is.na(aim2.pv.ultimate))!=
                                     nrow(aim2.pv.ultimate)]
#recodes
aim2.aaf.ultimate$AAF_ReasonForReferral<-gsub("^ReasonRef","",
                                              aim2.aaf.ultimate$AAF_ReasonForReferral)
aim2.aaf.ultimate$AAF_ReasonForReferral<-gsub("^RaesonRef","",
                                              aim2.aaf.ultimate$AAF_ReasonForReferral)
aim2.aaf.ultimate$AAF_ReasonForReferral<-gsub("?.ReasonRef.?","",
                                              aim2.aaf.ultimate$AAF_ReasonForReferral)
aim2.aaf.ultimate$AAF_DxForAnaemia<-gsub("^DxForAnemia_","",
                                         aim2.aaf.ultimate$AAF_DxForAnaemia)
aim2.aaf.ultimate$AAF_DxForAnaemia<-gsub("?.DxForAnemia.?","",
                                         aim2.aaf.ultimate$AAF_DxForAnaemia)
aim2.aaf.ultimate$AAF_ChronicAnaemiaCause<-gsub("^AnaemiaCause_","",
                                                aim2.aaf.ultimate$AAF_ChronicAnaemiaCause)
aim2.aaf.ultimate$AAF_PrevDelvComps<-str_trim(aim2.aaf.ultimate$AAF_PrevDelvComps,
                                              side=c("both"))
aim2.aaf.ultimate$AAF_PrevDelvComps<-gsub("^PrevDelvComps_","",
                                          aim2.aaf.ultimate$AAF_PrevDelvComps)
aim2.aaf.ultimate$AAF_ThisPregComps<-gsub("^ThisPregComps_","",
                                          aim2.aaf.ultimate$AAF_ThisPregComps)

#pull a sample of select variables for QC, then graphically show the data
#since we're only looking at first visit, create a data frame from aim2.lab 
  #that only shows the first visit for each patient
aim2.lab.first<-aim2.lab[
  !duplicated(aim2.lab$`Patient Number`),]
#join aim2.lab.first with aim2.aaf.ultimate
aim2.lab.aaf<-inner_join(aim2.lab.first,aim2.aaf.ultimate,
                         by=c("Patient Number"="AAF_StudyID"))
#keep only specified variables from aim2.lab.aaf
aim2.lab.aaf.spec<-aim2.lab.aaf[,c(3,4,9,65:67,80:82,84,204)]
#sort by Collection Date
aim2.lab.aaf.spec<-aim2.lab.aaf.spec[order(
  aim2.lab.aaf.spec$Collection_Date),]
#change the column names
colnames(aim2.lab.aaf.spec)<-c("AAF_StudyID",
                               "First_Hemoglobin_Date",
                               "Hemoglobin_of_First_Clinic_Visit",
                               "Hemoglobin_Before_Referral",
                               "Date_of_Last_Referring_Clinic",
                               "Hemoglobin_Method_Used",
                               "Date_Referred",
                               "Date_of_First_Clinic_Visit",
                               "Gestation_Age_First_Visit_Weeks",
                               "Reason_for_Referral",
                               "Booking_HIV_Status")
#QC the date values
diff.date<-as.numeric(aim2.lab.aaf.spec$First_Hemoglobin_Date - 
                        aim2.lab.aaf.spec$Date_of_Last_Referring_Clinic)
date.investigation1<-subset(aim2.lab.aaf.spec,
                           diff.date<0)
date.investigation2<-subset(aim2.lab.aaf.spec,
                            diff.date>=90)
date.investigation<-rbind(date.investigation1,
                          date.investigation2)
#identify row indeces which have the typos
which(diff.date<0 | diff.date>=90)
aim2.lab.aaf.spec[c(15,49,75,234,251,266,291,301,327,367,
                    436,450),]
aim2.lab.aaf.spec[15,5]<-as.Date("2014-08-21",format="%Y-%m-%d")
aim2.lab.aaf.spec[49,5]<-as.Date("2014-09-10",format="%Y-%m-%d")
aim2.lab.aaf.spec[75,5]<-as.Date("2014-09-22",format="%Y-%m-%d")
aim2.lab.aaf.spec[234,5]<-as.Date("2015-01-06",format="%Y-%m-%d")
aim2.lab.aaf.spec[251,5]<-as.Date("2014-12-03",format="%Y-%m-%d")
aim2.lab.aaf.spec[266,5]<-as.Date("2014-11-15",format="%Y-%m-%d")
aim2.lab.aaf.spec[291,5]<-as.Date("2014-12-03",format="%Y-%m-%d")
aim2.lab.aaf.spec[301,5]<-as.Date("2015-01-14",format="%Y-%m-%d")
aim2.lab.aaf.spec[327,5]<-as.Date("2014-11-11",format="%Y-%m-%d")
aim2.lab.aaf.spec[367,5]<-as.Date("2015-01-30",format="%Y-%m-%d")
aim2.lab.aaf.spec[436,5]<-as.Date("2015-04-10",format="%Y-%m-%d")
aim2.lab.aaf.spec[450,5]<-as.Date("2015-05-07",format="%Y-%m-%d")
```

##Overview of this Document
First, I will present a table corresponding to the probable typos I found and corrected within variable "Date of Referring Clinic," which was necessary to complete this week's action items.
Second, I will present paired scatterplots of the Hemoglobin levels for each patient. The first graph is an overall picture, then after that I have the paired observations plotted month by month.
Third, I will present relative frequency histograms of the hemoglobin levels at the first lab visit and at referral.
Fourth, I will present two frequency histograms of the hemoglobin levels before referral by method used: FBC and Point of Care. (There was an "other" method that contained only one observation, and 23 observations that did not have a method marked. These were not graphed.)
Fifth, I will present counts of the observations when applied to the two different inclusion criteria. One dependent on the Hemoglobin level at the first visit of the lab, and the other dependent on the Hemoglobin level at referral. I also show quality-check cross tabulations of these inclusion criteria.
Sixth, I will present histograms of the hemoglobin levels when applied to the inclusion criteria.
Seventh, I will present graphs of the difference in days between the variables "First Hemoglobin Visit" and "Date of Referring Clinic." The first graph is an x-y scatterplot, where the x-value is hemoglobin level and the y-value is the difference in days. The second graph is a frequency histogram of the difference in days.

##Table of Date Typos

I created this table by taking the difference of the date values, in days, between the variables "First Hemoglobin Date" (from the lab data) and the aforementioned variable "Date of Last Referring Clinic." If the difference was negative (i.e., the lab visit was earlier than the referral visit) or greater than 90 days, then those observations are in this table.

##Plots of Hemoglobin Paired
```{r plot1, warning=FALSE,message=FALSE,echo=FALSE}
#plot paired hemoglobin vs. date
  #gather the hemoglobin values by key
aim2.lab.aaf.spec.paired<-aim2.lab.aaf.spec %>% 
  gather(key="Time",value="Hemoglobin",
         Hemoglobin_of_First_Clinic_Visit:Hemoglobin_Before_Referral)
aim2.lab.aaf.spec.paired<-aim2.lab.aaf.spec.paired[
  c("AAF_StudyID","Hemoglobin","Time","First_Hemoglobin_Date",
    "Date_of_Last_Referring_Clinic","Hemoglobin_Method_Used",
    "Gestation_Age_First_Visit_Weeks","Booking_HIV_Status",
    "Reason_for_Referral","Date_Referred","Date_of_First_Clinic_Visit")]
  #order by studyID
aim2.lab.aaf.spec.paired<-aim2.lab.aaf.spec.paired[
  order(aim2.lab.aaf.spec.paired$AAF_StudyID),]
#make a the intervaal date column
  #first make vectors containing lab and referral hemoglobin date values
lab.Date<-aim2.lab.aaf.spec.paired$First_Hemoglobin_Date
referr.Date<-aim2.lab.aaf.spec.paired$Date_of_Last_Referring_Clinic
  #insert NA values in preparation for the merger
lab.Date[seq(2,length(lab.Date),by=2)]<-NA
referr.Date[seq(1,length(referr.Date),by=2)]<-NA
  #combine the two vectors by non-NA values
Int.Date<-pmin(lab.Date,referr.Date,na.rm=TRUE)
  #add the interval date to the data frame, then rearrange
aim2.lab.aaf.spec.paired$Int.Date<-Int.Date
aim2.lab.aaf.spec.paired<-aim2.lab.aaf.spec.paired[c(1:3,12,4:11)]
#rename factor levels of column Time
aim2.lab.aaf.spec.paired$Time<-revalue(
  aim2.lab.aaf.spec.paired$Time,
  c("Hemoglobin_Before_Referral"="Before Referral",
    "Hemoglobin_of_First_Clinic_Visit"="First Clinic Visit"))
#plot hemoglobin paired vs date
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(labels=date_format("%m-%d")) + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired")
#plot hemoglobin paired vs date (July & August)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2014-07-01','2014-09-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (July & August 2014)")
#plot hemoglobin paired vs date (September 2014)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2014-09-01','2014-10-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (September 2014)")
#plot hemoglobin paired vs date (October 2014)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2014-10-01','2014-11-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (October 2014)")
#plot hemoglobin paired vs date (November2014 )
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2014-11-01','2014-12-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2))  +
  ggtitle("Hemoglobin Paired (November 2014)")
#plot hemoglobin paired vs date (December 2014)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2014-12-01','2015-01-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2))  +
  ggtitle("Hemoglobin Paired (December 2014)")
#plot hemoglobin paired vs date (January 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-01-01','2015-02-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2))  +
  ggtitle("Hemoglobin Paired (January 2015)")
#plot hemoglobin paired vs date (February 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-02-01','2015-03-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2))  +
  ggtitle("Hemoglobin Paired (February 2015)")
#plot hemoglobin paired vs date (March 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-03-01','2015-04-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (March 2015)")
#plot hemoglobin paired vs date (April 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-04-01','2015-05-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (April 2015)")
#plot hemoglobin paired vs date (May 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-05-01','2015-06-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (May 2015)")
#plot hemoglobin paired vs date (June & July 2015)
ggplot(aim2.lab.aaf.spec.paired,aes(Int.Date,Hemoglobin)) + 
  geom_path(group=aim2.lab.aaf.spec.paired$AAF_StudyID) + 
  geom_point(aes(colour=factor(Time))) + 
  scale_x_date(limits=as.Date(c('2015-06-01','2015-08-01')),
               labels=date_format("%m-%d"),
               date_minor_breaks = "1 day") + 
  scale_y_continuous(breaks=seq(0,14,2)) +
  ggtitle("Hemoglobin Paired (June & July 2015)")

```

##Histograms of Hemoglobin

```{r plot2, warning=FALSE,message=FALSE,echo=FALSE}
#plot hemoglobin of first clinic visit
  #calculate binwidth
n<-sum(!is.na(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit))
n
root.n<-sqrt(sum(!is.na(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit)))
min2max<-max(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit) - 
  min(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit)
bw<-min2max/root.n
bw
  #plot
ggplot(aim2.lab.aaf.spec,aes(Hemoglobin_of_First_Clinic_Visit)) + 
  geom_histogram(binwidth=.4,aes(y=..density..),fill="green",
                 color="black") + 
  geom_density(alpha=.3,fill="green4") +
  labs(x="Hemoglobin Level",y="Density") + 
  ggtitle("Density of Hemoglobin at First Clinic Visit")

#plot hemoglobin before referral
  #calculate binwidth
n<-sum(!is.na(aim2.lab.aaf.spec$Hemoglobin_Before_Referral))
n
root.n<-sqrt(sum(!is.na(aim2.lab.aaf.spec$Hemoglobin_Before_Referral)))
min2max<-max(aim2.lab.aaf.spec$Hemoglobin_Before_Referral,na.rm = TRUE) - 
  min(aim2.lab.aaf.spec$Hemoglobin_Before_Referral,na.rm = TRUE)
bw<-min2max/root.n
bw
  #plot
ggplot(aim2.lab.aaf.spec,aes(Hemoglobin_Before_Referral)) + 
  geom_histogram(binwidth=.4,aes(y=..density..),fill="red",
                 color="black") + 
  geom_density(alpha=.3,fill="red4") +
  labs(x="Hemoglobin Level",y="Density") + 
  ggtitle("Density of Hemoglobin Before Referral")
```

#Histograms of Hemoglobin Before Referral by Method
```{r plot5,warning=FALSE,message=FALSE,echo=FALSE}
#plot multiple graphs by method used for hemoglobin before referral
  #method: FBC
fbc.hgb.ref<-subset(aim2.lab.aaf.spec,
                    Hemoglobin_Method_Used=="01 FBC")
ggplot(fbc.hgb.ref,aes(Hemoglobin_Before_Referral)) + 
  geom_histogram(binwidth=.1,position="dodge",fill="firebrick") +
  labs(x="Hemoglobin Level",y="Count") + 
  ggtitle("Hemoglobin Before Referral by FBC Method") + 
  scale_x_continuous(breaks=seq(4,14,1),
                     minor_breaks = seq(4,14,.1))
  #method: Point of Care
poc.hgb.ref<-subset(aim2.lab.aaf.spec,
                    Hemoglobin_Method_Used=="02 PointOfCare")
ggplot(poc.hgb.ref,aes(Hemoglobin_Before_Referral)) + 
  geom_histogram(binwidth=.1,position="dodge",fill="purple") +
  labs(x="Hemoglobin Level",y="Count") + 
  ggtitle("Hemoglobin Before Referral by Point of Care Method") + 
  scale_x_continuous(breaks=seq(4,14,1),
                     minor_breaks = seq(4,14,.1))
```

##Inclusion Criteria

```{r chunk5, warning=FALSE,message=FALSE,echo=FALSE}
#gather the hemoglobin values by inclusion criteria
  #inclusion criteria by first lab visit
inclusion.lab<-NA
inclusion.lab[#(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<8) | 
             (aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<10# & 
                #aim2.lab.aaf.spec$Gestation_Age_First_Visit_Weeks >=36) | 
             #(aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<9 & 
                #aim2.lab.aaf.spec$Booking_HIV_Status=="01 HIV+"
             )]<-"Yes"
inclusion.lab[is.na(inclusion.lab)]<-"No"
table(inclusion.lab)
  #QC of inclusion.lab
anemia.def<-NA
anemia.def[
  aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<8]<-"Hb<8g/dl"
anemia.def[
  (aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<9 & 
     aim2.lab.aaf.spec$Booking_HIV_Status=="01 HIV+")]<-"Hb<9g/dl:HIV+"
anemia.def[
  (aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<10 & 
     aim2.lab.aaf.spec$Gestation_Age_First_Visit_Weeks>=36)]<-"Hb<10/dl:\u226536wks"
anemia.def[is.na(anemia.def)]<-"all else"
summary(freqlist(table(inclusion.lab,
                       anemia.def),
                 labelTranslations = c("Included by Hgb @ Lab?",
                                       "Anemia Definition")))
  #inclusion by referral
#inclusion.ref<-NA
#inclusion.ref[(aim2.lab.aaf.spec$Hemoglobin_Before_Referral<8) | 
#            (aim2.lab.aaf.spec$Hemoglobin_Before_Referral<10 & 
  #             aim2.lab.aaf.spec$Gestation_Age_First_Visit_Weeks >=36) | 
  #          (aim2.lab.aaf.spec$Hemoglobin_Before_Referral<9 & 
  #             aim2.lab.aaf.spec$Booking_HIV_Status=="01 HIV+")]<-"Yes"
#inclusion.ref[is.na(inclusion.ref)]<-"No"
#table(inclusion.ref)
  #QC of inclusion.ref
#anemia.def<-NA
#anemia.def[
#  aim2.lab.aaf.spec$Hemoglobin_Before_Referral<8]<-"Hb<8g/dl"
#anemia.def[
#  (aim2.lab.aaf.spec$Hemoglobin_Before_Referral<9 & 
#     aim2.lab.aaf.spec$Booking_HIV_Status=="01 HIV+")]<-"Hb<9g/dl:HIV+"
#anemia.def[
  #(aim2.lab.aaf.spec$Hemoglobin_Before_Referral<10 & 
  #   aim2.lab.aaf.spec$Gestation_Age_First_Visit_Weeks>=36)]<-"Hb<10/dl:\u226536wks"
#anemia.def[is.na(anemia.def)]<-"all else"
#summary(freqlist(table(inclusion.ref,
#                       anemia.def),
#                 labelTranslations = c("Included by Hgb @ Ref.?",
#                                       "Anemia Definition")))
#stratify inclusion referral table by Lab First Hgb Level
#hgb.binary<-NA
#hgb.binary[
#  aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit<10]<-"Hb<10/dl"
#hgb.binary[
#  aim2.lab.aaf.spec$Hemoglobin_of_First_Clinic_Visit>=10]<-"Hb\u226510/dl"
#summary(freqlist(table(hgb.binary,
#                       inclusion.ref,
#                       anemia.def),
#                 labelTranslations = c("Hemoglobin Level",
#                                       "Included by Hgb @ Ref.?",
#                                       "Anemia Definition")))
```

##Histograms of Hemoglobin Levels (Inclusion Criteria)

```{r plot6,warning=FALSE,message=FALSE,echo=FALSE}
#remake plots with inclusion criteria
aim2.lab.aaf.spec$inclusion.lab<-inclusion.lab
#aim2.lab.aaf.spec$inclusion.ref<-inclusion.ref
incl.lab.aim2.lab.aaf<-subset(aim2.lab.aaf.spec,
                              inclusion.lab=="Yes")
#incl.ref.aim2.lab.aaf<-subset(aim2.lab.aaf.spec,
#                              inclusion.ref=="Yes")
#plot hemoglobin of first clinic visit
  #calculate binwidth
n<-sum(!is.na(incl.lab.aim2.lab.aaf$Hemoglobin_of_First_Clinic_Visit))
n
root.n<-sqrt(sum(!is.na(incl.lab.aim2.lab.aaf$Hemoglobin_of_First_Clinic_Visit)))
min2max<-max(incl.lab.aim2.lab.aaf$Hemoglobin_of_First_Clinic_Visit,na.rm = TRUE) - 
  min(incl.lab.aim2.lab.aaf$Hemoglobin_of_First_Clinic_Visit,na.rm = TRUE)
bw<-min2max/root.n
bw
  #plot
ggplot(incl.lab.aim2.lab.aaf,aes(Hemoglobin_of_First_Clinic_Visit)) + 
  geom_histogram(binwidth=.3,aes(y=..density..),fill="chartreuse",
                 color="black") + 
  geom_density(alpha=.3,fill="chartreuse") +
  labs(x="Hemoglobin Level",y="Density") + 
  ggtitle("Density of Hemoglobin at First Clinic Visit (Inclusion)")
#plot hemoglobin before referral
  #calculate binwidth
n<-sum(!is.na(incl.lab.aim2.lab.aaf$Hemoglobin_Before_Referral))
n
root.n<-sqrt(sum(!is.na(incl.lab.aim2.lab.aaf$Hemoglobin_Before_Referral)))
min2max<-max(incl.lab.aim2.lab.aaf$Hemoglobin_Before_Referral,na.rm = TRUE) - 
  min(incl.lab.aim2.lab.aaf$Hemoglobin_Before_Referral,na.rm = TRUE)
bw<-min2max/root.n
bw
  #plot
ggplot(incl.lab.aim2.lab.aaf,aes(Hemoglobin_Before_Referral)) + 
  geom_histogram(binwidth=.3,aes(y=..density..),fill="firebrick1",
                 color="black") + 
  geom_density(alpha=.3,fill="firebrick4") +
  labs(x="Hemoglobin Level",y="Density") + 
  ggtitle("Density of Hemoglobin Before Referral (Inclusion)")
```

##Date Difference Histograms

```{r plot10,warning=FALSE,message=FALSE,echo=FALSE}
#plot difference in date interval by hemoglobin at referral
diff.date<-as.numeric(aim2.lab.aaf.spec$First_Hemoglobin_Date - 
                        aim2.lab.aaf.spec$Date_of_Last_Referring_Clinic)
aim2.lab.aaf.spec$diff.date<-diff.date
ggplot(aim2.lab.aaf.spec,
       aes(x=Hemoglobin_Before_Referral,
           y=diff.date)) + 
  geom_point() +
  labs(x="Hemoglobin Level Before Referral",
       y="Difference in Days") + 
  ggtitle("Hgb Level: Interval Between First Lab Visit & Date of Referring Clinic")
#interval idfference between First Hemoglobin Date and Date of Last Referring 
  #Clinic
n<-sum(!is.na(aim2.lab.aaf.spec$diff.date))
n
root.n<-sqrt(sum(!is.na(aim2.lab.aaf.spec$diff.date)))
min2max<-max(aim2.lab.aaf.spec$diff.date,na.rm = TRUE) - 
  min(aim2.lab.aaf.spec$diff.date,na.rm = TRUE)
bw<-min2max/root.n
bw
ggplot(aim2.lab.aaf.spec, aes(diff.date)) + 
  geom_histogram(binwidth=6) + 
  labs(x="Days",y="count") + 
  ggtitle("Freq. of Date Difference (Lab Visit & Referring Clinic) (Binwidth=6)") + 
  scale_x_continuous(minor_breaks = seq(0,130,6)) +
  stat_bin(binwidth=6,aes(y=..count..,label=..count..),
           geom="text",vjust=-.2)
```

##LOESS Plot
```{r plot12,echo=FALSE}
#make scatterplots, stratified by HIV status, of Hgb at visit 1 by 
  #gestational age, with a superimposed loess curve
#remove missing HIV values
aim2.lab.aaf.spec<-aim2.lab.aaf.spec[
  !is.na(aim2.lab.aaf.spec$Booking_HIV_Status),]
#rename factor levels
aim2.lab.aaf.spec$Booking_HIV_Status<-revalue(
  aim2.lab.aaf.spec$Booking_HIV_Status,
  c("01 HIV+"="HIV+","02 HIV-"="HIV-"))
ggplot(aim2.lab.aaf.spec,
       aes(x=Gestation_Age_First_Visit_Weeks,
           y=Hemoglobin_of_First_Clinic_Visit,
           color=Booking_HIV_Status)) + 
  geom_point(position="jitter",na.rm = TRUE) + 
  geom_smooth(method="loess") + 
  scale_color_discrete(name="HIV Status") + 
  scale_x_continuous(breaks=seq(4,40,4),
                     limits=c(4,40)) + 
  scale_y_continuous(breaks=seq(5,15,2)) + 
  labs(x="Weeks",y="Hemoglobin Level g/dl") + 
  ggtitle("Hemoglobin Level at First Visit as a Function of Gestation Age")
```

##Tables
```{r chunk9,echo=FALSE}
#make a table of Hemoglobin Level, HIV Status, and Gestation Age in months
#by first clinic visit
  #create variable gestation age months
Gestation_Age_First_Visit_Month<-floor(
  aim2.lab.aaf.spec$Gestation_Age_First_Visit_Weeks/4)
aim2.lab.aaf.spec$Gestation_Age_First_Visit_Month<-Gestation_Age_First_Visit_Month
  #create table
hiv.age.hgb.tab<-aim2.lab.aaf.spec %>% 
  select(Booking_HIV_Status,
         Gestation_Age_First_Visit_Month,
         Hemoglobin_of_First_Clinic_Visit) %>% 
  group_by(Booking_HIV_Status,Gestation_Age_First_Visit_Month) %>% 
  summarise(Median=median(Hemoglobin_of_First_Clinic_Visit),
            IQR=IQR(Hemoglobin_of_First_Clinic_Visit),
            Q1=quantile(Hemoglobin_of_First_Clinic_Visit,probs=.25),
            Q3=quantile(Hemoglobin_of_First_Clinic_Visit,probs=.75))
hiv.age.hgb.tab %>% print(n = Inf)
#by all visits
MergedAIM2_short<-MergedAIM2_QX[c(3,4,9,174,319)]
  #create variable gestation age months
MergedAIM2_short$GestAge_Wks<-NA
MergedAIM2_short$tf.dup<-duplicated(MergedAIM2_short$`Patient Number`)
for (i in 1:NROW(MergedAIM2_short)) { 
  if(MergedAIM2_short$tf.dup[i]==FALSE) 
    {MergedAIM2_short$GestAge_Wks[i]<-MergedAIM2_short$AAF_GestAge1stVisit_Wks[i]}
  else {MergedAIM2_short$GestAge_Wks[i]<-((as.numeric(
    MergedAIM2_short$Collection_Date[i] - MergedAIM2_short$Collection_Date[i-1]))/7) + 
      MergedAIM2_short$GestAge_Wks[i-1]}
}
Gestation_Age_Month<-floor(MergedAIM2_short$GestAge_Wks/4)
MergedAIM2_short$Gestation_Age_Month<-Gestation_Age_Month
  #create table
hiv.age.hgb.tab.all<-MergedAIM2_short %>% 
  select(BookingHIVStatus,
         Gestation_Age_Month,
         Haemoglobin) %>% 
  group_by(BookingHIVStatus,Gestation_Age_Month) %>% 
  summarise(Median=median(Haemoglobin),
            IQR=IQR(Haemoglobin),
            Q1=quantile(Haemoglobin,probs=.25),
            Q3=quantile(Haemoglobin,probs=.75))
hiv.age.hgb.tab.all %>% print(n = Inf)
```