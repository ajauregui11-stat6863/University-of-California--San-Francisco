---
title: "Investigation of Transfusion Counts"
author: "Adam Jauregui"
date: "December 11, 2018"
output: word_document
---

```{r setup, include=FALSE}
library(readr)
library(ggplot2)
library(arsenal)
library(tableone)
aim3.dat.clean <- read_csv(
  "C:/Users/Adam/Documents/BSRI/TIP Stuff/aim3_Dat_imp (column shift update).csv", 
                         col_types = cols(ATF_AdmDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_BookingDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate1 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate2 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate3 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate4 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate5 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate6 = col_date(format = "%m/%d/%Y"), 
                                          ATF_ComponentsTXDate7 = col_date(format = "%m/%d/%Y"), 
                                          ATF_DschgDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_EstDateDelivery = col_date(format = "%m/%d/%Y"), 
                                          ATF_HIVStatusBookingDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_HIVStatusDelvAdmitDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_HIVStatusOthTestDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_PMTCTStartDate = col_date(format = "%m/%d/%Y"), 
                                          ATF_TodayDate = col_date(format = "%m/%d/%Y"), 
                                          ChartAbstrationDate = col_date(format = "%m/%d/%Y"), 
                                          ConsentDate = col_date(format = "%m/%d/%Y"), 
                                          CreatedDate = col_date(format = "%m/%d/%Y")))
View(aim3.dat.clean)

#subset out Groote/Schurr hospitals
aim3_chris.king<-subset(aim3.dat.clean,
                              LOCATION=="Chris Hani" | 
                                LOCATION=="King Edward")

#add gestation weeks
gest.wks.tri<-cut(aim3_chris.king$ATF_GestAgeWks,
              breaks=c(-Inf,13,25,Inf),
              label=c("<14","14-25",">25"),
              right=FALSE)
aim3_chris.king$gest.wks.tri<-gest.wks.tri
aim3_chris.king<-aim3_chris.king[c(1:16,115,17:114)]
aim3_chris.king<-aim3_chris.king[-c(112)]

#rename column
colnames(aim3_chris.king)[
  colnames(aim3_chris.king)=="ATF_Transfused.x"
]<-"ATF_Transfused"
```

## Investigation of Transfusion Totals

```{r investigation}
#investigation of RBC, platelet, and plasma counts
grep("^red*",colnames(aim3_chris.king))
grep("^plt*",colnames(aim3_chris.king))
grep("^ffp*",colnames(aim3_chris.king))
redT<-rowSums(aim3_chris.king[c(91:97)],na.rm=TRUE)
plateT<-rowSums(aim3_chris.king[c(98:104)],na.rm=TRUE)
plasmaT<-rowSums(aim3_chris.king[c(105:111)],na.rm = TRUE)
all(redT==aim3_chris.king$redTotal)
all(plateT==aim3_chris.king$pltTotal)
all(plasmaT==aim3_chris.king$ffpTotal)
```

We see that summing the RBC, plate, and plasma rows, they equal the columns that pertain to their respective totals.

##Verify Tx. Entry by Tx. Type

```{r investigation2}
attach(aim3_chris.king)
col1<-red1
col2<-ATF_ComponentsTxType1
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red2
col2<-ATF_ComponentsTxType2
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red3
col2<-ATF_ComponentsTxType3
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red4
col2<-ATF_ComponentsTxType4
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red5
col2<-ATF_ComponentsTxType5
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red6
col2<-ATF_ComponentsTxType6
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-red7
col2<-ATF_ComponentsTxType7
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt1
col2<-ATF_ComponentsTxType1
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt2
col2<-ATF_ComponentsTxType2
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt3
col2<-ATF_ComponentsTxType3
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt4
col2<-ATF_ComponentsTxType4
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt5
col2<-ATF_ComponentsTxType5
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt6
col2<-ATF_ComponentsTxType6
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-plt7
col2<-ATF_ComponentsTxType7
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp1
col2<-ATF_ComponentsTxType1
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp2
col2<-ATF_ComponentsTxType2
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp3
col2<-ATF_ComponentsTxType3
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp4
col2<-ATF_ComponentsTxType4
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp5
col2<-ATF_ComponentsTxType5
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp6
col2<-ATF_ComponentsTxType6
summary(freqlist(table(col1,col2,useNA = "ifany")))
col1<-ffp7
col2<-ATF_ComponentsTxType7
summary(freqlist(table(col1,col2,useNA = "ifany")))
detach(aim3_chris.king)
```

We see that if a patient was listed as receiving a RBC, plasma, or platelet transfusion, then they were marked a value of "1" for that respective transfusion in either of the "red," "plt," or "ffp" columns. Everything checks out. Some of the transfusion types contain numbers, which we assume to be an incorrect entry for the time and can be disregarded. The researcher made an attempt to find an obvious placement for the incorrectly placed time entry, but there was none.

##Inclusion Criteria

Since we know that the transfusions were marked and totaled correctly, we can remove the observations that do not have an entry for a transfusion (by there being a value of "0" in all of the columns that pertain to the total number of transfusions by type: RBC, platelet, and plasma).

```{r investigation3,warning=FALSE}
#if an observation has an entry in the last 3 columns 
#(redTotal, pltTotal, and ffpTotal) that sum to zero,
#then we know that that patient did not get transfused, 
#and thus we can remove them

#sums
grep("Total$",colnames(aim3_chris.king))
summary(freqlist(table(aim3_chris.king$ATF_Transfused,
      rowSums(aim3_chris.king[c(112:114)]),useNA = "ifany")),
      labelTranslations=c("Q6.4 Transfused?","red+plt+ffp Total"))
summary(freqlist(table(aim3_chris.king$redTotal,
                       aim3_chris.king$pltTotal,
                       aim3_chris.king$ffpTotal),
                 labelTranslations = c("RBC Total",
                                       "Platelet Total",
                                       "Plasma Total")))
```